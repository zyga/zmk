name: Tests
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
jobs:
  make-check:
    strategy:
      matrix:
        system: [ubuntu-latest, macos-latest]
    env:
      DEBUG: spawn,import,verision
    runs-on: ${{ matrix.system }}
    steps:
    - uses: actions/checkout@v2
    - run: git fetch --depth=1 origin +refs/tags/*:refs/tags/*
    - run: git fetch --prune --unshallow --tags
    - name: register make problem matcher
      run: echo "::add-matcher::${{ github.workspace }}/.github/make.json"
    - name: Check make version
      run: make --version
    - name: Create dist archive
      run: make --warn-undefined-variables dist
    - uses: actions/upload-artifact@v2
      with:
        name: dist-archive
        path: zmk_*.tar.gz
    - name: Unpack dist archive in /tmp
      run: tar zxvf ${{ github.workspace }}/zmk_*.tar.gz -C /tmp
    - name: Install from dist archive
      run: make --warn-undefined-variables -C /tmp/zmk_* install -j2 DESTDIR=/tmp/DIST
    - name: Install missing ObjC compiler
      if: runner.os == 'Linux'
      run: sudo apt-get install gobjc
    - name: Check from dist archive
      run: make --warn-undefined-variables -C /tmp/zmk_* check -j2
